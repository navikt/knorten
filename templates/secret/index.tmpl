{{ define "secrets/index" }}
    {{ template "head" . }}
    <article class="bg-white rounded-md p-4">
        <h2 class="pb-4">Hemmeligheter</h2>
        <p class="flex items-center gap-4 pb-4">
            Her kan du definere grupper med hemmeligheter som vil lagres i google secret manager og synkes ut i
            clusteret som kubernetes secrets i team namespacet deres. Disse kubernetes secretene kan du så velge 
            å mounte inn og sette som miljøvariabler Airflow worker pods.
        </p>
        {{ with .errors }}
            {{ . }}
        {{ end }}
        <button id="new-group-button"  onClick="addNewGroup()" class="mb-4 navds-button navds-button--primary navds-button--small">
            <span class="navds-label">Ny gruppe</span>
        </button>
    </article>

    <script>
        let groupCounter = 0;
        const groupCounterMap = new Map();

        function addNewGroup() {
            const groupID = addGroup()
            addElement(groupID)
        }

        function addGroup(name = undefined, nameReadOnly = false) {
            groupCounter += 1
            const groupCount = groupCounter
            if (name === undefined) {
                name = "ny-gruppe-"+groupCount
            }

            groupCounterMap[groupCount] = {"name": name, "secretCount": 0}

            var groupInput = document.createElement("input");
            if (nameReadOnly) {
                groupInput.setAttribute("class", "cursor-default outline-none");
                groupInput.readOnly = nameReadOnly;
            }
            else {
                groupInput.setAttribute("class", "navds-text-field__input navds-body-short navds-body-medium mb-2");
                groupInput.setAttribute("onchange", "updateNewGroupName("+groupCount+", this.value)")
            }
            groupInput.setAttribute("id", "group-num-"+groupCount);
            groupInput.setAttribute("value", groupCounterMap[groupCount].name);

            var groupForm = document.createElement("form");
            groupForm.setAttribute("id", "form-"+groupCount);
            groupForm.setAttribute("class", "mb-6 border-solid border-2 p-2");
            groupForm.setAttribute("method", "POST");
            groupForm.setAttribute("action", "/team/{{ .slug }}/secrets/"+groupCounterMap[groupCount].name);

            var groupFieldset = document.createElement("fieldset");

            var valuesDiv = document.createElement("div");
            valuesDiv.setAttribute("id", "values-"+groupCount);
            groupFieldset.appendChild(valuesDiv);

            var newElementButtonDiv = document.createElement("div");
            var newElementButton = document.createElement("button");
            newElementButton.setAttribute("type", "button");
            newElementButton.setAttribute("class", "mb-4 navds-button navds-button--secondary navds-button--small");
            newElementButton.setAttribute("onclick", "addElement("+groupCount+")");
            newElementButtonDiv.appendChild(newElementButton);

            var newElementButtonSpan = document.createElement("span");
            newElementButtonSpan.setAttribute("class", "navds-label");
            newElementButtonSpan.innerText = "Nytt felt";
            newElementButton.appendChild(newElementButtonSpan);
            groupFieldset.appendChild(newElementButtonDiv);

            groupForm.appendChild(groupFieldset);

            var submitButtonDiv = document.createElement("div");
            submitButtonDiv.setAttribute("class", "pure-controls");

            var submitButton = document.createElement("button");
            submitButton.setAttribute("type", "submit");
            submitButton.setAttribute("class", "navds-button navds-button--primary bg-surface-action");

            var submitButtonSpan = document.createElement("span");
            submitButtonSpan.setAttribute("class", "navds-label");
            submitButtonSpan.innerText = "Lagre";

            submitButtonDiv.appendChild(submitButton);
            submitButton.appendChild(submitButtonSpan);

            groupForm.appendChild(submitButtonDiv);

            const newGroupButton = document.getElementById("new-group-button");
            newGroupButton.parentNode.insertBefore(groupInput, newGroupButton);
            newGroupButton.parentNode.insertBefore(groupForm, newGroupButton);

            return groupCount
        }

        function updateNewGroupName(groupID, newName) {
            console.log(groupID)
            console.log(newName)
            groupCounterMap[groupID].name = newName
            const groupForm = document.getElementById("form-"+groupID)
            groupForm.setAttribute("action", "/team/{{ .slug }}/secrets/"+groupCounterMap[groupID].name)
        }

        function deleteRow(event, id) {
            const valueDiv = document.getElementById(id);
            valueDiv.parentNode.removeChild(valueDiv)
        }

        function addElement(groupID, key = undefined, value = undefined) {
            var existingSecret = true
            var valueInputType = "password"
            if (key === undefined) {
                key = ""
                value = ""
                existingSecret = false
                valueInputType = "text"
            }

            groupCounterMap[groupID].secretCount += 1
            currentID = groupID+"-"+groupCounterMap[groupID].secretCount
            const valuesDiv = document.getElementById("values-"+groupID)
            const keyValueDiv = document.createElement("div");
            keyValueDiv.setAttribute("class", "mb-4")
            keyValueDiv.setAttribute("id", groupID+"-"+groupCounterMap[groupID].secretCount)

            const keyDiv = document.createElement("div");
            keyDiv.setAttribute("class", "flex gap-2");
            keyDiv.setAttribute("id", "key."+groupID+"."+groupCounterMap[groupID].secretCount);

            var keyInput = document.createElement("input");
            if (existingSecret) {
                keyInput.setAttribute("class", "cursor-default outline-none");
                keyInput.readOnly = true;
            } else {
                keyInput.setAttribute("class", "navds-text-field__input navds-body-short navds-body-medium mb-2");
            }
            keyInput.setAttribute("type", "text");
            keyInput.setAttribute("name", "key."+groupID+"."+groupCounterMap[groupID].secretCount);
            keyInput.setAttribute("id", "key."+groupID+"."+groupCounterMap[groupID].secretCount);
            keyInput.setAttribute("value", key);
            keyDiv.appendChild(keyInput);

            keyValueDiv.appendChild(keyDiv);

            const valueDiv = document.createElement("div");
            valueDiv.setAttribute("class", "flex gap-2");
            valueDiv.setAttribute("id", groupID+"-"+key);

            var valueInput = document.createElement("input");
            const valueID = "value."+groupID+"."+groupCounterMap[groupID].secretCount
            valueInput.setAttribute("class", "navds-text-field__input navds-body-short navds-body-medium");
            valueInput.setAttribute("type", valueInputType);
            valueInput.setAttribute("name", valueID);
            valueInput.setAttribute("id", valueID);
            valueInput.setAttribute("value", value);
            valueDiv.appendChild(valueInput);

            if (existingSecret) {
                var showValueToggleDiv = document.createElement("div");
                showValueToggleDiv.setAttribute("class", "flex flex-col justify-center align-middle");
                var showValueToggleSVG = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                showValueToggleSVG.setAttribute("class", "cursor-pointer");
                showValueToggleSVG.setAttribute("width", "2em");
                showValueToggleSVG.setAttribute("height", "2em");
                showValueToggleSVG.setAttribute("viewBox", "0 0 24 24");
                showValueToggleSVG.setAttribute("focusable", "false");
                showValueToggleSVG.setAttribute("role", "img");
                showValueToggleSVG.setAttribute("onclick", "toggleValueFieldHidden('"+valueID+"')");

                var showValueTogglePath = document.createElementNS("http://www.w3.org/2000/svg", "path");
                showValueTogglePath.setAttribute("id", "show."+valueID);
                showValueTogglePath.setAttribute("fill-rule", "evenodd");
                showValueTogglePath.setAttribute("clip-rule", "evenodd");
                showValueTogglePath.setAttribute("d", "M12 5c4.418 0 8.418 2.333 12 7-3.582 4.667-7.582 7-12 7s-8.418-2.333-12-7c3.582-4.667 7.582-7 12-7Zm5 7a5 5 0 1 1-10 0 5 5 0 0 1 10 0Zm-5 3a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z");
                showValueTogglePath.setAttribute("fill", "currentColor");

                showValueToggleSVG.appendChild(showValueTogglePath);
                showValueToggleDiv.appendChild(showValueToggleSVG);
                valueDiv.appendChild(showValueToggleDiv);
            }

            const delButton = document.createElement("button");
            delButton.setAttribute("class", "navds-button navds-button--secondary");
            delButton.setAttribute("type", "button");
            delButton.setAttribute("onclick", "deleteRow(event, '"+currentID+"')");
            const delLabel = document.createElement("span");
            delLabel.setAttribute("class", "navds-label");
            delLabel.innerText = "Slett";
            delButton.appendChild(delLabel);

            valueDiv.appendChild(delButton);
            keyValueDiv.appendChild(valueDiv);
            valuesDiv.appendChild(keyValueDiv);
        }

        function toggleValueFieldHidden(valueID) {
            const valueInput = document.getElementById(valueID)
            const showValueTogglePath = document.getElementById("show."+valueID)
            if (valueInput.getAttribute("type") === "password") {
                valueInput.setAttribute("type", "text")
                showValueTogglePath.setAttribute("d", "m22.207 3.207-3.674 3.674C20.453 8.046 22.275 9.752 24 12c-3.582 4.667-7.582 7-12 7-1.608 0-3.161-.31-4.658-.927l-4.135 4.134-1.414-1.414 3.674-3.674C3.547 15.954 1.725 14.248 0 12c3.582-4.667 7.582-7 12-7 1.608 0 3.161.31 4.658.927l4.135-4.134 1.414 1.414ZM12 17a5 5 0 0 0 4.172-7.757l-6.93 6.929c.791.523 1.739.828 2.758.828Zm-4.172-2.243 1.464-1.464a3 3 0 0 1 4.001-4.001l1.464-1.464a5 5 0 0 0-6.929 6.929Z")
            } 
            else {
                valueInput.setAttribute("type", "password")
                showValueTogglePath.setAttribute("d", "M12 5c4.418 0 8.418 2.333 12 7-3.582 4.667-7.582 7-12 7s-8.418-2.333-12-7c3.582-4.667 7.582-7 12-7Zm5 7a5 5 0 1 1-10 0 5 5 0 0 1 10 0Zm-5 3a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z")
            }
        }

        {{ range $group, $secretGroup := .secrets }}
                var groupID = addGroup({{ $group }}, true)
                {{ range $secretGroup.Secrets }}
                    addElement(groupID, "{{ .Name }}", "{{ .Value }}")
                {{ end }}
        {{ end }}
    </script>
    </article>
    {{ template "footer" }}
{{ end }}
